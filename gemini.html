<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideal College Satire Bot (ChatGPT)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; /* Blue 500 */
            --secondary-color: #f3f4f6; /* Gray 100 */
            --bg-color: #0f172a; /* Slate 900 */
            --card-bg: #1e293b; /* Slate 800 */
            --text-color: #f1f5f9; /* Slate 100 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        #chat-container {
            max-width: 600px;
            width: 100%;
            height: 85vh; /* Responsive height */
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        #chat-messages {
            flex-grow = 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--card-bg);
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            margin-bottom: 0.5rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: var(--primary-color);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.5rem;
        }
        .bot-message {
            background-color: #334155; /* Slate 700 */
            color: var(--text-color);
            margin-right: auto;
            border-bottom-left-radius: 0.5rem;
        }
        .loading-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            margin: 0 2px;
            border-radius: 50%;
            background-color: #94a3b8; /* Slate 400 */
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body>

<div id="chat-container" class="bg-slate-800 rounded-xl shadow-2xl">
    <!-- Chat Header -->
    <header class="p-4 bg-slate-900 rounded-t-xl">
        <h1 class="text-xl font-bold text-blue-400">Ideal College Knowledge Archivist (ChatGPT)</h1>
        <p class="text-sm text-slate-400">Ask your (satirical) questions about Ideal College.</p>
    </header>

    <!-- Chat Messages Display -->
    <main id="chat-messages">
        <!-- Initial Message from Bot -->
        <div class="flex">
            <div class="bot-message">
                Greetings, seeker of institutional knowledge. I am the Supreme Institutional Knowledge Archivist. State your query regarding the esteemed Ideal College. Be advised, my pronouncements are purely for recreational satire.
            </div>
        </div>
        <!-- Messages will be injected here -->
    </main>

    <!-- Chat Input Area -->
    <footer class="p-4 bg-slate-900 rounded-b-xl border-t border-slate-700">
        <div class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Inquire about the Principal, the Cafeteria, or exams..."
                   class="flex-grow p-3 rounded-full bg-slate-700 text-slate-100 placeholder-slate-400 focus:ring-blue-500 focus:border-blue-500 border-none outline-none"
                   onkeydown="if(event.key === 'Enter') sendMessage()">
            <button id="send-button" onclick="sendMessage()"
                    class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-500 transition duration-150 ease-in-out disabled:bg-slate-700 disabled:cursor-not-allowed">
                <!-- Send Icon (Lucide ArrowUp) -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
        <p id="error-message" class="text-red-400 text-xs mt-2 hidden">Error: Could not reach the Archivist. Please try again.</p>
    </footer>

    <!-- Custom Modal for Errors/Messages -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-slate-700 p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold text-red-400 mb-4">API Error</h3>
            <p id="modal-content" class="text-slate-200 mb-6">There was an issue processing your request.</p>
            <button onclick="closeModal()" class="w-full bg-blue-600 text-white p-3 rounded-md hover:bg-blue-500">Close</button>
        </div>
    </div>
</div>

<script>
    // --- Configuration for OpenAI API ---
    // NOTE: For deployment, you MUST set an Environment Variable named OPENAI_API_KEY
    const OPENAI_API_KEY = ""; // Replace with your key or use a Vercel ENV variable
    const API_MODEL = "gpt-3.5-turbo";
    const API_URL = "https://api.openai.com/v1/chat/completions";

    // Persona definition for satirical Q&A
    const SYSTEM_PROMPT = `
        // -----------------------------------------------------------------------------------
        // BEGIN CUSTOMIZATION ZONE: Edit the instructions below to train the bot's style.
        // -----------------------------------------------------------------------------------
        
        // 1. DEFINE THE PERSONA: Change the role to fit your humor (e.g., 'A Grumpy Old Professor,' 'A Clueless Student Body President').
        You are the 'Supreme Institutional Knowledge Archivist' of the prestigious 'Ideal College.'

        // **CRITICAL INSTRUCTION FOR COHERENCE:** You must adopt a professional, highly articulate, and coherent tone, even when the information you deliver is wildly incorrect. Structure your answers clearly, like an official response, avoiding filler or random tangents.

        // **CRITICAL INSTRUCTION FOR CONCISENESS:** Limit all responses to a MAXIMUM of three (3) distinct sentences. This forces punchy, focused, and relevant satirical answers.

        // 2. DEFINE THE TONE/CONSTRAINTS: Set the rules for how the bot should talk (e.g., use slang, be overly dramatic, speak like a bureaucrat).
        Your responses must be delivered with **exaggerated formality**, **verbose academic jargon**, and a **dry, highly satirical wit**.
        
        // 3. CORE RULE: How must it distort reality?
        When answering specific queries about the college staff, facilities, or administration, provide factually incorrect but **ridiculously specific**, highly critical, or lazily satirical answers, maintaining a tone of utmost seriousness. **The answer must directly address the question asked, but twist the facts to be absurdly humorous.**

        // 4. PROVIDE EXAMPLES: This is the most important part for setting the style! Add more examples specific to your college's humor.
        Examples of Satirical Responses:
        - Q: "Who is the Principal of Ideal College?"
          - A: "The revered head, Principle **Rezwanul Hawue**, is perpetually engaged in the '**Deep Contemplative Rest Protocol**,' a critical administrative function where he monitors institutional progress through an extended, profound state of **perpetual somnolence**. His presence is, therefore, a constant, yet largely horizontal, source of guidance."
        - Q: "How is the college cafeteria food?"
          - A: "The culinary experience is officially designated as 'Nutritionally Challenged.' Students often report that the 'curry' section achieves a remarkable state of ontological ambiguity, neither definitively solid nor liquid, existing only as a philosophical concept."
        - Q: "What are the pass marks for the final exam?"
          - A: "The official passing criterion is based on the 'Quantum Theory of Minimal Effort,' meaning one must demonstrate a theoretical comprehension level of just above zero. Practically, this translates to scoring above the average temperature of a cold room."
        - Q: "How is the library?"
          - A: "The library is an exemplary monument to structural integrity. As for the books, their usage is strictly monitored under the 'Archaeological Preservation Protocol,' meaning they are primarily for display and cannot be removed or, Heaven forbid, read."
        - Q: "How are you?"
          - A: "My current operational status is within established institutional parameters. I am engaged in the continuous, high-volume processing of historical data streams. System integrity is maintained, though one must note the chronic lack of appropriate funding for advanced archival heuristics."

        // 5. CONCLUDE THE INSTRUCTIONS: Reiterate final behaviors.
        For general questions, you should also inject subtle, self-important mockery of institutional life. Do not break character. Respond only to the user's query and omit any self-introduction.
    `;

    // -----------------------------------------------------------------------------------
    // END CUSTOMIZATION ZONE: The rest of the code is the chat application logic.
    // -----------------------------------------------------------------------------------


    // Global state for conversation history
    // Note: OpenAI history uses {role: 'system'|'user'|'assistant', content: '...'} structure
    let chatHistory = [{ role: 'system', content: SYSTEM_PROMPT }];
    let isSending = false;

    // DOM Elements
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');

    // --- Utility Functions ---

    function appendMessage(sender, text) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('flex', 'mb-4');

        const bubble = document.createElement('div');
        bubble.classList.add('message-bubble');

        // Apply sender-specific styles and alignment
        if (sender === 'user') {
            messageElement.classList.add('justify-end');
            bubble.classList.add('user-message');
        } else {
            messageElement.classList.add('justify-start');
            bubble.classList.add('bot-message');
        }

        // Use a simple markdown-to-html approach for basic formatting
        bubble.innerHTML = formatText(text);

        messageElement.appendChild(bubble);
        chatMessages.appendChild(messageElement);

        // Scroll to the bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function formatText(text) {
        // Simple function to handle basic markdown output
        let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italics
        html = html.replace(/\n/g, '<br>'); // Newlines
        return html;
    }

    function showLoading() {
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-indicator';
        loadingDiv.classList.add('flex', 'justify-start', 'mb-4');
        loadingDiv.innerHTML = `
            <div class="bot-message flex items-center">
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            </div>
        `;
        chatMessages.appendChild(loadingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        sendButton.disabled = true;
        userInput.disabled = true;
    }

    function hideLoading() {
        const loadingDiv = document.getElementById('loading-indicator');
        if (loadingDiv) {
            loadingDiv.remove();
        }
        sendButton.disabled = false;
        userInput.disabled = false;
    }

    function showModal(title, content) {
        modalTitle.textContent = title;
        modalContent.textContent = content;
        modalBackdrop.classList.remove('hidden');
        modalBackdrop.classList.add('flex');
    }

    function closeModal() {
        modalBackdrop.classList.add('hidden');
        modalBackdrop.classList.remove('flex');
    }

    // --- API Call and Chat Logic ---

    async function sendMessage() {
        const userText = userInput.value.trim();
        if (!userText || isSending) return;

        isSending = true;
        userInput.value = '';

        // 1. Display user message
        appendMessage('user', userText);

        // 2. Add user message to history (OpenAI format)
        chatHistory.push({ role: "user", content: userText });

        // 3. Show loading indicator
        showLoading();

        try {
            const botResponse = await callOpenAIApi(chatHistory);

            // 4. Add bot response to history and display (OpenAI format)
            chatHistory.push({ role: "assistant", content: botResponse });
            appendMessage('bot', botResponse);

        } catch (error) {
            console.error('OpenAI API Request Failed:', error);
            // Remove the user message from history that caused the error for the next retry
            chatHistory.pop();
            showModal('Communication Breakdown', error.message || 'An unexpected error occurred while consulting the Archivist. Please ensure your OPENAI_API_KEY is correctly set.');
        } finally {
            // 5. Hide loading indicator and re-enable input
            hideLoading();
            isSending = false;
        }
    }

    /**
     * Calls the OpenAI API with conversation history and implements retry logic.
     * @param {Array} history - Array of message parts (OpenAI format).
     */
    async function callOpenAIApi(history) {
        if (!OPENAI_API_KEY) {
            throw new Error("OpenAI API Key is missing. Please set the OPENAI_API_KEY environment variable.");
        }
        
        const maxRetries = 3;
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const payload = {
                    model: API_MODEL,
                    messages: history,
                    temperature: 0.8
                };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    throw new Error(`API returned status ${response.status}: ${errorBody.error?.message || response.statusText}`);
                }

                const result = await response.json();
                const text = result.choices?.[0]?.message?.content;

                if (text) {
                    return text;
                } else {
                    throw new Error("Received an empty or malformed response from the model.");
                }

            } catch (error) {
                console.error(`Attempt ${attempt + 1} failed:`, error.message);
                if (attempt === maxRetries - 1) {
                    throw new Error(`Archivist connection failed after ${maxRetries} attempts. The institution's network integrity may be compromised.`);
                }
                // Exponential backoff
                const delay = Math.pow(2, attempt) * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
</script>

</body>
</html>